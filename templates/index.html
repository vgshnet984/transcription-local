<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcription Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            margin-bottom: 40px;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #fafafa;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-area i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-area h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #333;
        }

        .upload-area p {
            color: #666;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            margin-bottom: 40px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(
                -45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 50px 50px;
            animation: move 2s linear infinite;
        }

        @keyframes move {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 50px 50px;
            }
        }

        .progress-text {
            text-align: center;
            color: #333;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .results-section {
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .results-header h2 {
            color: #333;
        }

        .download-btn {
            background: #28a745;
        }

        .transcription-text {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            line-height: 1.6;
            white-space: pre-wrap;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .segments-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 10px;
        }

        .segment {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
        }

        .segment:last-child {
            border-bottom: none;
        }

        .segment-time {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-right: 15px;
            min-width: 80px;
            text-align: center;
        }

        .segment-speaker {
            background: #f8f9fa;
            color: #495057;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-right: 15px;
            font-weight: bold;
        }

        .segment-text {
            flex: 1;
            color: #333;
        }

        .segment-confidence {
            color: #6c757d;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .speaker-label {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 8px;
            display: inline-block;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .file-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .file-info h4 {
            color: #0056b3;
            margin-bottom: 10px;
        }

        .file-info p {
            margin: 5px 0;
            color: #333;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .transcribe-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 40px;
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .transcribe-section h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .transcribe-section p {
            color: #666;
            margin-bottom: 20px;
        }

        .transcribe-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            font-size: 1.1rem;
            padding: 15px 30px;
        }

        .transcribe-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        }

        .config-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 40px;
        }

        .config-panel h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
        }

        .config-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .config-item select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .config-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .config-info {
            margin-top: 20px;
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .config-info p {
            margin-bottom: 15px;
            color: #495057;
        }

        .config-info ul {
            margin-bottom: 20px;
            padding-left: 20px;
        }

        .config-info li {
            margin-bottom: 8px;
            color: #6c757d;
            line-height: 1.5;
        }

        .config-info strong {
            color: #495057;
        }

        .engine-status {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 40px;
            border: 1px solid #e9ecef;
        }

        .engine-status h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .status-label {
            font-weight: 600;
            color: #495057;
        }

        .status-value {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .status-available {
            color: #28a745;
        }

        .status-unavailable {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎤 Transcription Platform</h1>
            <p>Advanced audio transcription with speaker identification and multiple engine support</p>
        </div>

        <div class="main-content">
            <!-- Engine Status Section -->
            <div class="engine-status" id="engineStatus">
                <h3>🔧 Engine Status</h3>
                <div class="status-grid" id="statusGrid">
                    <div class="status-item">
                        <span class="status-label">Loading...</span>
                        <span class="status-value">Checking engine status...</span>
                    </div>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="upload-section">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">📁</div>
                        <h3>Upload Audio File</h3>
                        <p>Drag and drop your audio file here, or click to browse</p>
                        <p><small>Supported formats: WAV, MP3, M4A, FLAC (Max 500MB)</small></p>
                        <input type="file" id="fileInput" class="file-input" accept="audio/*">
                        <button class="btn" id="chooseFileBtn">
                            Choose File
                        </button>
                    </div>

                    <!-- Transcription Options -->
                    <div class="transcription-options" style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h3>🔧 Transcription Options</h3>
                        <div class="options-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            
                            <div class="form-group">
                                <label for="engine">Engine:</label>
                                <select id="engine" name="engine" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="whisper">Whisper (Standard)</option>
                                    <option value="faster-whisper">Faster-Whisper (Fast)</option>
                                    <option value="whisperx">WhisperX (Enhanced)</option>
                                    <option value="parakeet">NVIDIA Parakeet (English)</option>
                                    <option value="wav2vec2">Wav2Vec2 (Fast English)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="model_size">Model Size:</label>
                                <select id="model_size" name="model_size" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="tiny">Tiny (Fastest)</option>
                                    <option value="base" selected>Base (Balanced)</option>
                                    <option value="small">Small (Better)</option>
                                    <option value="medium">Medium (Good)</option>
                                    <option value="large">Large (Best)</option>
                                    <option value="large-v3">Large-v3 (Best)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="language">Language:</label>
                                <select id="language" name="language" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="auto" selected>Auto-detect</option>
                                    <option value="en">English</option>
                                    <option value="hi">Hindi</option>
                                    <option value="ta">Tamil</option>
                                    <option value="te">Telugu</option>
                                    <option value="kn">Kannada</option>
                                    <option value="ml">Malayalam</option>
                                    <option value="gu">Gujarati</option>
                                    <option value="bn">Bengali</option>
                                    <option value="pa">Punjabi</option>
                                    <option value="ur">Urdu</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="vad_method">VAD Method:</label>
                                <select id="vad_method" name="vad_method" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="none">No VAD (Complete)</option>
                                    <option value="simple" selected>Simple VAD</option>
                                    <option value="webrtcvad">WebRTC VAD</option>
                                    <option value="silero">Silero VAD</option>
                                </select>
                            </div>

                            <div class="form-group" style="grid-column: span 2;">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="enable_speaker_diarization" name="enable_speaker_diarization">
                                    <strong>Enable Speaker Diarization</strong>
                                </label>
                            </div>

                            <div class="form-group" style="grid-column: span 2;">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="no_filtering" name="no_filtering">
                                    <strong>No Audio Filtering</strong> (faster processing, may reduce quality)
                                </label>
                            </div>

                            <div class="form-group" style="grid-column: span 2;">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="suppress_logs" name="suppress_logs" checked>
                                    <strong>Minimal Logging</strong> (cleaner output)
                                </label>
                            </div>

                        </div>
                    </div>

                </form>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <h3>Processing...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Initializing...</div>
            </div>

            <!-- Error Section -->
            <div class="error-message hidden" id="errorMessage"></div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <h2>Transcription Results</h2>
                    <button class="btn download-btn" id="downloadBtn">Download Results</button>
                </div>

                <!-- File Info -->
                <div class="file-info" id="fileInfo"></div>

                <!-- Full Transcription -->
                <h3>Full Transcription</h3>
                <div class="transcription-text" id="transcriptionText"></div>

                <!-- Segments with Speakers -->
                <h3>Segments with Speaker Identification</h3>
                <div class="segments-container" id="segmentsContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let pollInterval = null;

        // Load engine status when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadEngineStatus();
            
            // Hide any existing transcribe section on page load
            const existingTranscribeSection = document.getElementById('transcribeSection');
            if (existingTranscribeSection) {
                existingTranscribeSection.style.display = 'none';
                console.log('Hidden existing transcribe section on page load');
            }
            
            // Debug: Check if all form elements exist
            setTimeout(() => {
                console.log('=== FORM ELEMENTS DEBUG ===');
                const elements = {
                    language: document.getElementById('language'),
                    engine: document.getElementById('engine'),
                    model_size: document.getElementById('model_size'),
                    vad_method: document.getElementById('vad_method'),
                    enable_speaker_diarization: document.getElementById('enable_speaker_diarization'),
                    no_filtering: document.getElementById('no_filtering'),
                    suppress_logs: document.getElementById('suppress_logs')
                };
                
                console.log('All form elements:', elements);
                
                // Check which ones are null
                Object.entries(elements).forEach(([name, element]) => {
                    if (!element) {
                        console.error(`❌ Element '${name}' is NULL!`);
                    } else {
                        console.log(`✅ Element '${name}' found:`, element);
                    }
                });
                console.log('=== END DEBUG ===');
            }, 1000);
        });

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        console.log('Setting up file upload handlers...');
        console.log('Upload area:', uploadArea);
        console.log('File input:', fileInput);

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            console.log('Files dropped:', files);
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            console.log('File input changed:', e.target.files);
            if (e.target.files.length > 0) {
                console.log('Calling handleFileUpload with:', e.target.files[0]);
                handleFileUpload(e.target.files[0]);
            }
        });

        // Also add click handler to the upload area
        uploadArea.addEventListener('click', (e) => {
            console.log('Upload area clicked, triggering file input...');
            // Don't trigger if clicking on the file input itself
            if (e.target !== fileInput) {
                fileInput.click();
            }
        });

        // Make sure file input is properly accessible
        fileInput.style.display = 'none';
        fileInput.style.position = 'absolute';
        fileInput.style.opacity = '0';
        fileInput.style.pointerEvents = 'none';

        // Add click handler for the Choose File button
        const chooseFileBtn = document.getElementById('chooseFileBtn');
        console.log('Choose file button:', chooseFileBtn);
        if (chooseFileBtn) {
            chooseFileBtn.addEventListener('click', (e) => {
                console.log('Choose File button clicked');
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });
        }

        let uploadedFile = null;
        let uploadedFileId = null;

        async function handleFileUpload(file) {
            console.log('handleFileUpload called with:', file);
            console.log('File type:', file.type);
            console.log('File size:', file.size);
            
            // Validate file
            if (!file.type.startsWith('audio/')) {
                console.log('Invalid file type:', file.type);
                showError('Please select a valid audio file.');
                return;
            }

            if (file.size > 500 * 1024 * 1024) { // 500MB limit
                console.log('File too large:', file.size);
                showError('File size must be less than 500MB.');
                return;
            }

            console.log('File validation passed, uploading...');
            showProgress();
            hideError();
            hideResults();

            try {
                // Upload file only (no transcription yet)
                const formData = new FormData();
                formData.append('file', file);
                
                console.log('Uploading file to /api/upload...');
                
                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    throw new Error('Upload failed');
                }

                const uploadResult = await uploadResponse.json();
                console.log('Upload result:', uploadResult);
                
                uploadedFile = file;
                uploadedFileId = uploadResult.id;
                
                // Show file info and transcribe button
                hideProgress();
                showFileInfo(file, uploadResult);
                showTranscribeButton();

            } catch (error) {
                showError('Upload Error: ' + error.message);
                hideProgress();
            }
        }

        function showFileInfo(file, uploadResult) {
            const fileInfo = document.getElementById('fileInfo');
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            
            fileInfo.innerHTML = `
                <h4>📁 File Uploaded Successfully</h4>
                <p><strong>Filename:</strong> ${file.name}</p>
                <p><strong>Size:</strong> ${fileSizeMB} MB</p>
                <p><strong>Type:</strong> ${file.type}</p>
                <p><strong>File ID:</strong> ${uploadResult.id}</p>
                <p><strong>Status:</strong> Ready for transcription</p>
            `;
            fileInfo.style.display = 'block';
        }

        function showTranscribeButton() {
            console.log('=== showTranscribeButton called ===');
            console.log('uploadedFileId:', uploadedFileId);
            console.log('uploadedFile:', uploadedFile);
            
            if (!uploadedFileId) {
                console.error('No uploadedFileId found! showTranscribeButton called too early.');
                return;
            }
            
            const transcribeSection = document.getElementById('transcribeSection');
            console.log('Existing transcribeSection:', transcribeSection);

            if (!transcribeSection) {
                console.log('Creating new transcribe section...');
                // Create transcribe section if it doesn't exist
                const uploadSection = document.querySelector('.upload-section');
                console.log('Upload section found:', uploadSection);

                const newSection = document.createElement('div');
                newSection.id = 'transcribeSection';
                newSection.className = 'transcribe-section';
                newSection.innerHTML = `
                    <h3>🎯 Ready to Transcribe</h3>
                    <p>File uploaded successfully. Configure your settings and click "Start Transcription".</p>
                    <button class="btn transcribe-btn" id="startTranscriptionBtn">
                        🎤 Start Transcription
                    </button>
                `;
                uploadSection.parentNode.insertBefore(newSection, uploadSection.nextSibling);
                console.log('Transcribe section created and inserted');
                
                // Add event listener to the button
                const startBtn = document.getElementById('startTranscriptionBtn');
                if (startBtn) {
                    startBtn.addEventListener('click', startTranscription);
                    console.log('Event listener added to start button');
                }
            } else {
                console.log('Showing existing transcribe section');
                transcribeSection.style.display = 'block';
            }
        }

        async function startTranscription() {
            if (!uploadedFileId) {
                showError('Please upload a file first');
                return;
            }

            try {
                hideError();
                showProgress();

                // Show immediate feedback
                updateProgress(0, 'Starting transcription...');

                // Debug: Check each element before accessing
                const languageEl = document.getElementById('language');
                const engineEl = document.getElementById('engine');
                const modelSizeEl = document.getElementById('model_size');
                const vadMethodEl = document.getElementById('vad_method');
                const speakerDiarizationEl = document.getElementById('enable_speaker_diarization');
                const noFilteringEl = document.getElementById('no_filtering');
                const suppressLogsEl = document.getElementById('suppress_logs');

                console.log('Elements found:', {
                    language: languageEl,
                    engine: engineEl,
                    model_size: modelSizeEl,
                    vad_method: vadMethodEl,
                    enable_speaker_diarization: speakerDiarizationEl,
                    no_filtering: noFilteringEl,
                    suppress_logs: suppressLogsEl
                });

                // Fallback: Use default values if elements are not found
                const config = {
                    language: languageEl ? languageEl.value : 'auto',
                    engine: engineEl ? engineEl.value : 'whisper',
                    model_size: modelSizeEl ? modelSizeEl.value : 'base',
                    vad_method: vadMethodEl ? vadMethodEl.value : 'simple',
                    enable_speaker_diarization: speakerDiarizationEl ? speakerDiarizationEl.checked : false,
                    no_filtering: noFilteringEl ? noFilteringEl.checked : false,
                    suppress_logs: suppressLogsEl ? suppressLogsEl.checked : true
                };

                console.log('Transcription config (with fallbacks):', config);

                // Update progress to show we're sending the request
                updateProgress(5, 'Sending transcription request...');

                // Start transcription
                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        file_id: uploadedFileId,
                        ...config
                    })
                });

                if (!response.ok) {
                    throw new Error('Transcription failed to start');
                }

                const result = await response.json();
                console.log('Transcription started:', result);

                currentJobId = result.job_id;

                // Update progress to show job started
                updateProgress(10, 'Transcription job started...');

                // Start polling for job completion
                pollJobProgress();

            } catch (error) {
                showError('Transcription Error: ' + error.message);
                hideProgress();
            }
        }

        async function pollJobProgress() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/api/jobs/${currentJobId}/status`);
                if (!response.ok) {
                    throw new Error('Failed to get job status');
                }

                const result = await response.json();

                if (!result) {
                    throw new Error('Job not found');
                }

                const job = result;
                
                // Update progress with more detailed status
                let statusText = job.status;
                if (job.status === 'processing') {
                    statusText = 'Transcribing audio...';
                } else if (job.status === 'completed') {
                    statusText = 'Transcription completed!';
                } else if (job.status === 'failed') {
                    statusText = 'Transcription failed';
                }
                
                updateProgress(job.progress || 0, statusText);

                if (job.status === 'completed') {
                    hideProgress();
                    showSuccessMessage('Transcription completed successfully!');
                    
                    // Get the transcription result
                    await loadResults(currentJobId);
                } else if (job.status === 'failed') {
                    hideProgress();
                    showError('Transcription failed: ' + (job.error_message || 'Unknown error'));
                } else {
                    // Continue polling with faster interval for processing
                    const pollInterval = job.status === 'processing' ? 1000 : 2000; // 1 second for processing, 2 for pending
                    setTimeout(pollJobProgress, pollInterval);
                }

            } catch (error) {
                hideProgress();
                showError('Error checking job status: ' + error.message);
            }
        }

        async function loadResults(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}/result`);
                if (!response.ok) {
                    throw new Error('Failed to load transcription results');
                }

                const transcription = await response.json();
                displayResults(transcription);

            } catch (error) {
                showError('Error loading results: ' + error.message);
            }
        }

        function displayResults(transcription) {
            // Display file info with more details
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <h4>Transcription Results</h4>
                <p><strong>Confidence:</strong> ${(transcription.confidence * 100).toFixed(1)}%</p>
                <p><strong>Processing Time:</strong> ${transcription.processing_time ? transcription.processing_time.toFixed(2) + 's' : 'Unknown'}</p>
                <p><strong>Created:</strong> ${transcription.created_at ? new Date(transcription.created_at).toLocaleString() : 'Unknown'}</p>
                <p><strong>Text Length:</strong> ${transcription.text ? transcription.text.length : 0} characters</p>
            `;

            // Display full transcription with speaker labels
            const transcriptionText = document.getElementById('transcriptionText');
            
            // Format the text to highlight speaker labels
            let formattedText = transcription.text;
            if (formattedText) {
                // Highlight speaker labels with styling
                formattedText = formattedText.replace(/\[([^\]]+)\]/g, '<span class="speaker-label">[$1]</span>');
            }
            
            transcriptionText.innerHTML = formattedText || 'No transcription available';

            // Display segments if available
            const segmentsContainer = document.getElementById('segmentsContainer');
            if (transcription.segments && transcription.segments.length > 0) {
                segmentsContainer.innerHTML = transcription.segments.map(segment => `
                    <div class="segment">
                        <div class="segment-time">${formatTime(segment.start)} - ${formatTime(segment.end)}</div>
                        <div class="segment-speaker">${segment.speaker || 'Unknown'}</div>
                        <div class="segment-text">${segment.text || ''}</div>
                        <div class="segment-confidence">${(segment.confidence * 100).toFixed(0)}%</div>
                    </div>
                `).join('');
            } else {
                segmentsContainer.innerHTML = '<p>No segments available</p>';
            }

            showResults();
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateProgress(progress, status) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${progress}%`;
            progressText.textContent = status;
        }

        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
        }

        function showResults() {
            document.getElementById('resultsSection').style.display = 'block';
        }

        function hideResults() {
            document.getElementById('resultsSection').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            // Auto-hide error after 5 seconds
            setTimeout(() => {
                hideError();
            }, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showSuccessMessage(message) {
            // Create success message element if it doesn't exist
            let successDiv = document.getElementById('successMessage');
            if (!successDiv) {
                successDiv = document.createElement('div');
                successDiv.id = 'successMessage';
                successDiv.className = 'success-message';
                successDiv.style.cssText = `
                    background: #d4edda;
                    color: #155724;
                    padding: 15px;
                    border-radius: 10px;
                    margin-bottom: 20px;
                    border: 1px solid #c3e6cb;
                    text-align: center;
                    font-weight: bold;
                `;
                
                // Insert after error message
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.parentNode.insertBefore(successDiv, errorDiv.nextSibling);
            }
            
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            
            // Auto-hide success message after 3 seconds
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 3000);
        }

        async function loadEngineStatus() {
            try {
                const response = await fetch('/engine-status');
                if (!response.ok) {
                    throw new Error('Failed to load engine status');
                }

                const engineInfo = await response.json();
                const statusGrid = document.getElementById('statusGrid');
                
                if (engineInfo.status === 'ready') {
                    let statusHTML = '';
                    
                    // Add engine features
                    statusHTML += `
                        <div class="status-item">
                            <span class="status-label">Status</span>
                            <span class="status-value status-available">✅ Ready</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Model</span>
                            <span class="status-value">${engineInfo.model_info?.current_model?.toUpperCase() || 'Unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Device</span>
                            <span class="status-value">${engineInfo.model_info?.current_device || 'Unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Fast-Whisper</span>
                            <span class="status-value ${engineInfo.model_info?.faster_whisper_available ? 'status-available' : 'status-unavailable'}">
                                ${engineInfo.model_info?.faster_whisper_available ? '✅ Available' : '❌ Not Available'}
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">WhisperX</span>
                            <span class="status-value ${engineInfo.model_info?.whisperx_available ? 'status-available' : 'status-unavailable'}">
                                ${engineInfo.model_info?.whisperx_available ? '✅ Available' : '❌ Not Available'}
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">CUDA Support</span>
                            <span class="status-value ${engineInfo.model_info?.cuda_available ? 'status-available' : 'status-unavailable'}">
                                ${engineInfo.model_info?.cuda_available ? '✅ Available' : '❌ Not Available'}
                            </span>
                        </div>
                    `;
                    
                    statusGrid.innerHTML = statusHTML;
                } else {
                    statusGrid.innerHTML = `
                        <div class="status-item">
                            <span class="status-label">Status</span>
                            <span class="status-value status-unavailable">❌ Error: ${engineInfo.error || 'Unknown error'}</span>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Failed to load engine status:', error);
                const statusGrid = document.getElementById('statusGrid');
                statusGrid.innerHTML = `
                    <div class="status-item">
                        <span class="status-label">Status</span>
                        <span class="status-value status-unavailable">Failed to load</span>
                    </div>
                `;
            }
        }

        // Download functionality
        document.getElementById('downloadBtn').addEventListener('click', async () => {
            // We need to store the transcription ID globally
            if (!window.currentTranscriptionId) return;

            try {
                const response = await fetch(`/api/transcriptions/${window.currentTranscriptionId}/download`);
                if (!response.ok) {
                    throw new Error('Download failed');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `transcription_${window.currentTranscriptionId}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

            } catch (error) {
                showError('Download failed: ' + error.message);
            }
        });
    </script>
</body>
</html> 